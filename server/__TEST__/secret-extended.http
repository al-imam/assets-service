@baseUrl = http://localhost:8000/api/v1

###

@sign_in_auth = {{sign_in.response.body.auth}}

# @name sign_in
POST {{baseUrl}}/auth/sign-in
Content-Type: application/json

{
  "email": "alimam@example.com",
  "password": "alimam@example.com"
}

### ============ READ TOKEN ADVANCED TESTS ============

@bucket_id = {{create_bucket.response.body.id}}

# @name create_bucket
POST {{baseUrl}}/buckets/
Content-Type: application/json
Cookie: auth={{sign_in_auth}}

{
  "name": "Read Token Test Bucket"
}

###

@configured_bucket_id = {{create_configured_bucket.response.body.id}}

# @name create_configured_bucket
POST {{baseUrl}}/buckets/
Content-Type: application/json
Cookie: auth={{sign_in_auth}}

{
  "name": "Configured Read Token Test Bucket",
  "config": {
    "allowedFileTypes": [".txt", ".pdf", "image/*"],
    "maxFileSize": 2097152
  }
}

###

@secret_with_expiry_id = {{create_secret_with_expiry.response.body.id}}

# @name create_secret_with_expiry
POST {{baseUrl}}/secrets/
Content-Type: application/json
Cookie: auth={{sign_in_auth}}

{
  "secret": "Secret with expiry for read token testing",
  "expiresAt": "2025-12-31T23:59:59.000Z",
  "validationUri": "https://example.com/validate-token"
}

###

@secret_no_expiry_id = {{create_secret_no_expiry.response.body.id}}

# @name create_secret_no_expiry
POST {{baseUrl}}/secrets/
Content-Type: application/json
Cookie: auth={{sign_in_auth}}

{
  "secret": "Secret without expiry for read token testing"
}

###

@secret_short_expiry_id = {{create_secret_short_expiry.response.body.id}}

# @name create_secret_short_expiry
POST {{baseUrl}}/secrets/
Content-Type: application/json
Cookie: auth={{sign_in_auth}}

{
  "secret": "Secret with short expiry",
  "expiresAt": "2025-08-03T00:00:00.000Z"
}

###

@read_token_with_expiry = {{issue_read_token_with_expiry.response.body.readToken}}

# @name issue_read_token_with_expiry
POST {{baseUrl}}/secrets/issue/read-token
X-Secret: Secret with expiry for read token testing
Content-Type: application/json

{
  "secret": "Secret with expiry for read token testing",
  "bucketId": "{{bucket_id}}",
  "keys": ["test.txt", "document.pdf", "images/photo.jpg"]
}

###

@read_token_no_expiry = {{issue_read_token_no_expiry.response.body.readToken}}

# @name issue_read_token_no_expiry
POST {{baseUrl}}/secrets/issue/read-token
X-Secret: Secret without expiry for read token testing
Content-Type: application/json

{
  "secret": "Secret without expiry for read token testing",
  "bucketId": "{{configured_bucket_id}}",
  "keys": ["test.txt", "document.pdf"]
}

###

# @name issue_read_token_nonexistent_secret
POST {{baseUrl}}/secrets/issue/read-token
X-Secret: This secret does not exist anywhere
Content-Type: application/json

{
  "bucketId": "{{bucket_id}}",
  "keys": ["test.txt"]
}

###

# @name issue_read_token_nonexistent_bucket
POST {{baseUrl}}/secrets/issue/read-token
X-Secret: Secret with expiry for read token testing
Content-Type: application/json

{
  "bucketId": "01HQWERTYUIOPASDFGHJKLZXCVB",
  "keys": ["test.txt"]
}

###

# @name issue_read_token_no_secret_header
POST {{baseUrl}}/secrets/issue/read-token
Content-Type: application/json

{
  "bucketId": "{{bucket_id}}",
  "keys": ["test.txt"]
}

###

# @name issue_read_token_empty_keys
POST {{baseUrl}}/secrets/issue/read-token
X-Secret: Secret with expiry for read token testing
Content-Type: application/json

{
  "bucketId": "{{bucket_id}}",
  "keys": []
}

###

# @name verify_read_token_with_expiry
POST {{baseUrl}}/secrets/verify-read-token
Content-Type: application/json

{
  "readToken": "{{read_token_with_expiry}}"
}

###

# @name verify_read_token_no_expiry
POST {{baseUrl}}/secrets/verify-read-token
Content-Type: application/json

{
  "readToken": "{{read_token_no_expiry}}"
}

###

# @name verify_malformed_read_token
POST {{baseUrl}}/secrets/verify-read-token
Content-Type: application/json

{
  "readToken": "not.a.valid.jwt.token"
}

###

# @name verify_empty_read_token
POST {{baseUrl}}/secrets/verify-read-token
Content-Type: application/json

{
  "readToken": ""
}

###

# @name verify_read_token_missing_body
POST {{baseUrl}}/secrets/verify-read-token
Content-Type: application/json

{}

### ============ SECRET MANAGEMENT TESTS ============

# @name get_all_secrets
GET {{baseUrl}}/secrets/
Cookie: auth={{sign_in_auth}}

###

# @name get_secret_with_expiry
GET {{baseUrl}}/secrets/{{secret_with_expiry_id}}
Cookie: auth={{sign_in_auth}}

###

# @name get_secret_no_expiry
GET {{baseUrl}}/secrets/{{secret_no_expiry_id}}
Cookie: auth={{sign_in_auth}}

###

# @name get_nonexistent_secret
GET {{baseUrl}}/secrets/01HQWERTYUIOPASDFGHJKLZXCVB
Cookie: auth={{sign_in_auth}}

###

# @name get_secret_no_auth
GET {{baseUrl}}/secrets/{{secret_with_expiry_id}}

###

# @name create_secret_invalid_expiry
POST {{baseUrl}}/secrets/
Content-Type: application/json
Cookie: auth={{sign_in_auth}}

{
  "secret": "Secret with invalid expiry",
  "expiresAt": "invalid-date-format"
}

###

# @name create_secret_past_expiry
POST {{baseUrl}}/secrets/
Content-Type: application/json
Cookie: auth={{sign_in_auth}}

{
  "secret": "Secret with past expiry",
  "expiresAt": "2020-01-01T00:00:00.000Z"
}

###

# @name create_secret_empty_content
POST {{baseUrl}}/secrets/
Content-Type: application/json
Cookie: auth={{sign_in_auth}}

{
  "secret": "",
  "expiresAt": "2025-12-31T23:59:59.000Z"
}

###

# @name create_secret_no_auth
POST {{baseUrl}}/secrets/
Content-Type: application/json

{
  "secret": "Unauthorized secret creation",
  "expiresAt": "2025-12-31T23:59:59.000Z"
}

###

# @name delete_secret_with_expiry
DELETE {{baseUrl}}/secrets/{{secret_with_expiry_id}}
Cookie: auth={{sign_in_auth}}

###

# @name delete_secret_no_expiry
DELETE {{baseUrl}}/secrets/{{secret_no_expiry_id}}
Cookie: auth={{sign_in_auth}}

###

# @name delete_secret_short_expiry
DELETE {{baseUrl}}/secrets/{{secret_short_expiry_id}}
Cookie: auth={{sign_in_auth}}

###

# @name delete_nonexistent_secret
DELETE {{baseUrl}}/secrets/01HQWERTYUIOPASDFGHJKLZXCVB
Cookie: auth={{sign_in_auth}}

###

# @name delete_secret_no_auth
DELETE {{baseUrl}}/secrets/{{secret_with_expiry_id}}

###

# @name delete_expired_secrets_cleanup
DELETE {{baseUrl}}/secrets/expired/cleanup
Cookie: auth={{sign_in_auth}}

###

# @name delete_expired_secrets_no_auth
DELETE {{baseUrl}}/secrets/expired/cleanup

###

# @name cleanup_bucket
DELETE {{baseUrl}}/buckets/{{bucket_id}}
Cookie: auth={{sign_in_auth}}

###

# @name cleanup_configured_bucket
DELETE {{baseUrl}}/buckets/{{configured_bucket_id}}
Cookie: auth={{sign_in_auth}}
